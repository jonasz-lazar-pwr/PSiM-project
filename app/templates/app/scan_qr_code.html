{% extends 'template.html' %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-3">Skanuj kod QR</h1>
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="d-flex justify-content-center align-items-center mt-5" style="height: auto;">
                <div id="reader" style="width:100%; height:auto;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
<script>
    console.log("Skrypt rozpoczął działanie");
    const scanner = new Html5QrcodeScanner("reader", {
        fps: 25,
        qrbox: 250
    });

    scanner.render(success, error);

    function success(result) {
        fetch('/api/verify_qr_code', {
            method: 'POST',
            body: JSON.stringify({qr_code: result}),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => response.json())
          .then(data => {
            if (data.success) {
                window.location.href = data.url;
            } else {
                alert(data.message);
                if (data.url) {
                    window.location.href = data.url;
                }
            }
        });

        scanner.clear();
        if(document.getElementById('reader')) {
            document.getElementById('reader').remove();
        }
    }

    function error(err) {}
</script>
{% endblock %}
